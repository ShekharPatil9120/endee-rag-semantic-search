{% extends "base.html" %}

{% block title %}Crop Recommendation System{% endblock %}

{% block content %}
<div class="container mt-5 p-4 rounded shadow" style="max-width: 700px; background: #ffffffcc;">
    <h2 class="text-center text-success mb-4">ğŸŒ¾ Crop Recommendation System</h2>

    <form method="POST" class="mb-4">
        {% csrf_token %}

        <div class="mb-3 text-end">
            <button type="button" id="fetch-live-data" class="btn btn-outline-primary">Fetch Live Data</button>
        </div>

        <div class="row">
            <div class="col-md-6">
                <label>ğŸŒ¡ï¸ Temperature (Â°C):</label>
                <input id="id_temperature" type="number" step="0.1" name="temperature" class="form-control" required>

                <label class="mt-3">ğŸ’§ Humidity (%):</label>
                <input id="id_humidity" type="number" step="0.1" name="humidity" class="form-control" required>

                <label class="mt-3">ğŸŒ± Nitrogen (N):</label>
                <input id="id_nitrogen" type="number" step="0.1" name="nitrogen" class="form-control" required>

                <label class="mt-3">ğŸ§ª Phosphorus (P):</label>
                <input id="id_phosphorus" type="number" step="0.1" name="phosphorus" class="form-control" required>
            </div>

            <div class="col-md-6">
                <label>ğŸ§ª Potassium (K):</label>
                <input id="id_potassium" type="number" step="0.1" name="potassium" class="form-control" required>

                <label class="mt-3">ğŸŒ¬ï¸ Air Quality Index:</label>
                <input id="id_air_quality" type="number" step="0.1" name="air_quality" class="form-control" required>

                <label class="mt-3">ğŸ“… Month Start (1â€“12):</label>
                <input type="number" name="month_start" min="1" max="12" class="form-control" required>

                <label class="mt-3">ğŸ“… Month End (1â€“12):</label>
                <input type="number" name="month_end" min="1" max="12" class="form-control" required>
            </div>
        </div>

        <div class="text-center mt-4">
            <input type="submit" value="ğŸš€ Get Recommendation" class="btn btn-success px-4">
            <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary ms-3">â† Back to Dashboard</a>
        </div>
    </form>

    {% if result %}
    <div class="result mt-5 p-3 bg-light border-start border-success border-4 rounded">
        <h4 class="text-success mb-3">âœ… Recommendation Results</h4>
        <p><strong>Most Recommended Crop:</strong> {{ result.most_recommended }}</p>
        <p><strong>Possible Cultivation:</strong> {{ result.possible_cultivation }}</p>
        <p><strong>Suggestions:</strong> {{ result.suggestions }}</p>
    </div>
    {% elif error %}
    <div class="alert alert-danger mt-4">{{ error }}</div>
    {% endif %}
</div>
<script>
document.getElementById('fetch-live-data').addEventListener('click', async function(){
    const btn = this;
    btn.disabled = true;
    btn.innerText = 'Fetching...';
    
    try {
        // âœ… Use local proxy endpoint instead of external API (avoids CORS)
        const res = await fetch('/crop_api/get-live-sensors/', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            },
            cache: 'no-store'
        });
        
        // âœ… Check response status
        if (!res.ok) {
            throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        }
        
        // âœ… Parse JSON response
        const data = await res.json();
        
        // âœ… Verify data exists and no error field
        if (!data || data.error) {
            throw new Error(data.error || 'No data received');
        }
        
        // âœ… Populate form fields with safe fallbacks
        const temperature = data.temperature ?? '';
        const humidity = data.humidity ?? '';
        const air_quality = data.air_quality ?? '';
        
        // âœ… Update form inputs if elements exist
        const tempInput = document.getElementById('id_temperature');
        const humInput = document.getElementById('id_humidity');
        const aqInput = document.getElementById('id_air_quality');
        
        if (tempInput) tempInput.value = temperature;
        if (humInput) humInput.value = humidity;
        if (aqInput) aqInput.value = air_quality;
        
        // âœ… Success feedback
        alert(`âœ… Live data loaded successfully!\nTemp: ${temperature}Â°C | Humidity: ${humidity}%`);
        
    } catch (err) {
        console.error('Error fetching live sensor data:', err);
        
        // âœ… Show user-friendly error message
        let errorMsg = 'Failed to fetch live sensor data.';
        if (err.message.includes('HTTP')) {
            errorMsg += ` Server error: ${err.message}`;
        } else if (err.message.includes('fetch')) {
            errorMsg += ' Network connection failed.';
        } else {
            errorMsg += ` Error: ${err.message}`;
        }
        
        alert(`âŒ ${errorMsg}\nPlease try again.`);
        
    } finally {
        // âœ… Reset button state
        btn.disabled = false;
        btn.innerText = 'Fetch Live Data';
    }
});
</script>
{% endblock %}
